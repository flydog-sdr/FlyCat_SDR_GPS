L.LatLngGraticule=L.Layer.extend({options:{showLabel:!0,opacity:1,weight:.8,color:"#aaa",font:"13px Verdana",fontColor:"black",lngLineCurved:0,latLineCurved:0,zoomInterval:[{start:2,end:2,interval:40},{start:3,end:3,interval:20},{start:4,end:4,interval:10},{start:5,end:7,interval:5},{start:8,end:20,interval:1}]},initialize:function(t){L.setOptions(this,t);this.options.font.split(" ").length<2&&(this.options.font+=" Verdana"),this.options.fontColor||(this.options.fontColor=this.options.color),this.options.zoomInterval&&(this.options.zoomInterval.latitude&&(this.options.latInterval=this.options.zoomInterval.latitude,this.options.zoomInterval.longitude||(this.options.lngInterval=this.options.zoomInterval.latitude)),this.options.zoomInterval.longitude&&(this.options.lngInterval=this.options.zoomInterval.longitude,this.options.zoomInterval.latitude||(this.options.latInterval=this.options.zoomInterval.longitude)),this.options.latInterval||(this.options.latInterval=this.options.zoomInterval),this.options.lngInterval||(this.options.lngInterval=this.options.zoomInterval))},onAdd:function(t){this._map=t,this._container||this._initCanvas(),t._panes.overlayPane.appendChild(this._container),t.on("viewreset",this._reset,this),t.on("load",this._reset,this),t.on("move",this._reset,this),t.on("moveend",this._reset,this),t.on("zoomend",this._reset,this),this._reset()},onRemove:function(t){t.getPanes().overlayPane.removeChild(this._container),t.off("viewreset",this._reset,this),t.off("load",this._reset,this),t.off("move",this._reset,this),t.off("moveend",this._reset,this),t.off("zoomend",this._reset,this)},addTo:function(t){return t.addLayer(this),this},setOpacity:function(t){return this.options.opacity=t,this._updateOpacity(),this},bringToFront:function(){return this._container&&this._map._panes.overlayPane.appendChild(this._container),this},bringToBack:function(){var t=this._map._panes.overlayPane;return this._container&&t.insertBefore(this._container,t.firstChild),this},getAttribution:function(){return this.options.attribution},_initCanvas:function(){this._container=L.DomUtil.create("div","leaflet-image-layer"),this._canvas=L.DomUtil.create("canvas",""),this._map.options.zoomAnimation&&L.Browser.any3d?L.DomUtil.addClass(this._canvas,"leaflet-zoom-animated"):L.DomUtil.addClass(this._canvas,"leaflet-zoom-hide"),this._updateOpacity(),this._container.appendChild(this._canvas),L.extend(this._canvas,{onselectstart:L.Util.falseFn,onmousemove:L.Util.falseFn,onload:L.bind(this._onCanvasLoad,this)})},_reset:function(){var t=this._container,n=this._canvas,i=this._map.getSize(),o=this._map.containerPointToLayerPoint([0,0]);L.DomUtil.setPosition(t,o),t.style.width=i.x+"px",t.style.height=i.y+"px",n.width=i.x,n.height=i.y,n.style.width=i.x+"px",n.style.height=i.y+"px",this.__calcInterval(),this.__draw(!0)},_onCanvasLoad:function(){this.fire("load")},_updateOpacity:function(){L.DomUtil.setOpacity(this._canvas,this.options.opacity)},__format_lat:function(t){return this.options.latFormatTickLabel?this.options.latFormatTickLabel(t):t<0?-1*t+"S":t>0?t+"N":""+t},__format_lng:function(t){return this.options.lngFormatTickLabel?this.options.lngFormatTickLabel(t):t>180?360-t+"W":t>0&&t<180?t+"E":t<0&&t>-180?-1*t+"W":-180==t?""+-1*t:t<-180?360+t+"W":""+t},__calcInterval:function(){var t=this._map.getZoom();if(this._currZoom!=t&&(this._currLngInterval=0,this._currLatInterval=0,this._currZoom=t),!this._currLngInterval)try{for(var n in this.options.lngInterval){if((i=this.options.lngInterval[n]).start<=t&&i.end&&i.end>=t){this._currLngInterval=i.interval;break}}}catch(t){this._currLngInterval=0}if(!this._currLatInterval)try{for(var n in this.options.latInterval){var i;if((i=this.options.latInterval[n]).start<=t&&i.end&&i.end>=t){this._currLatInterval=i.interval;break}}}catch(t){this._currLatInterval=0}},__draw:function(t){function n(t,n,i){var o=l.opacity;l.opacity=1;var a=l.fillStyle;l.fillStyle="black";var e=Math.ceil(h),s=Math.ceil(c);l.fillRect(n,i-s+2,e,s),l.fillStyle="white",l.fillText(t,n,i),l.opacity=o,l.fillStyle=a}var i=this._canvas,o=this._map,a=this.options.lngLineCurved,e=this.options.latLineCurved;if(L.Browser.canvas&&o){this._currLngInterval&&this._currLatInterval||this.__calcInterval();var s=this._currLatInterval,r=this._currLngInterval,l=i.getContext("2d");l.clearRect(0,0,i.width,i.height),l.lineWidth=this.options.weight,l.strokeStyle=this.options.color,l.fillStyle=this.options.fontColor,this.options.font&&(l.font=this.options.font);var h=l.measureText("0").width,c=13;try{var v=l.font.split(" ")[0];c=function(t){t.length>2&&"p"==t.charAt(t.length-2)&&(t=t.substr(0,t.length-2));try{return parseInt(t,10)}catch(t){}return 0}(v)}catch(t){}var p=i.width,_=i.height,f=o.containerPointToLatLng(L.point(0,0)),g=o.containerPointToLatLng(L.point(p,0)),u=o.containerPointToLatLng(L.point(p,_)).lat,d=f.lat,y=f.lng,m=g.lng,x=(d-u)/(.2*_);x<1&&(x=1),u=u<-90?-90:parseInt(u-x,10),d=d>90?90:parseInt(d+x,10);var I=(m-y)/(.2*p);I<1&&(I=1),y>0&&m<0&&(m+=360),m=parseInt(m+I,10),y=parseInt(y-I,10);var T,P,C,b=.5;function w(i,s){if(T=o.latLngToContainerPoint(L.latLng(s,y)),P=i.__format_lat(s),h=l.measureText(P).width,e){"number"==typeof e&&(b=e);var r=y,v=m;if(T.x>0)r=(r=o.containerPointToLatLng(L.point(0,T.y))).lng-I,T.x=0;(d=o.latLngToContainerPoint(L.latLng(s,v))).x<p&&(v=(v=o.containerPointToLatLng(L.point(p,d.y))).lng+I,r>0&&v<0&&(v+=360)),l.beginPath(),l.moveTo(T.x,T.y);for(var _=null,f=r;f<=v;f+=b){if(d=o.latLngToContainerPoint(L.latLng(s,f)),l.lineTo(d.x,d.y),i.options.showLabel&&t&&null!=_)if(_.x<0&&d.x>=0){var g=(d.x-0)/(d.x-_.x),u=d.y-(d.y-_.y)*g;n(P,0,u+c/2)}else if(_.x<=p-h&&d.x>p-h){g=(d.x-p)/(d.x-_.x),u=d.y-(d.y-_.y)*g;n(P,p-h,u+c/2-2)}_={x:d.x,y:d.y,lon:f,lat:z}}l.stroke()}else{v=m;var d=o.latLngToContainerPoint(L.latLng(s,v));if(a)v=(v=o.containerPointToLatLng(L.point(0,d.y))).lng,d=o.latLngToContainerPoint(L.latLng(s,v)),r=(r=o.containerPointToLatLng(L.point(p,d.y))).lng,T=o.latLngToContainerPoint(L.latLng(s,r));if(l.beginPath(),l.moveTo(T.x+1,T.y),l.lineTo(d.x-1,d.y),l.stroke(),i.options.showLabel&&t){var x=T.y+c/2-2;n(P,0,x),n(P,p-h,x)}}}if(s>0){for(var z=s;z<=d;z+=s)z>=u&&w(this,z);for(z=0;z>=u;z-=s)z<=d&&w(this,z)}function k(i,s){C=i.__format_lng(s),h=l.measureText(C).width;var r=o.latLngToContainerPoint(L.latLng(u,s));if(a){"number"==typeof a&&(_lat_delta=a),l.beginPath(),l.moveTo(r.x,r.y);for(var v=null,p=u;p<d;p+=_lat_delta){var f=o.latLngToContainerPoint(L.latLng(p,s));l.lineTo(f.x,f.y),i.options.showLabel&&t&&null!=v&&(v.y>8&&f.y<=8?n(C,f.x-h/2,c):v.y>=_&&f.y<_&&n(C,f.x-h/2,_-2)),v={x:f.x,y:f.y,lon:s,lat:p}}l.stroke()}else{var g=d;f=o.latLngToContainerPoint(L.latLng(g,s));if(e){(g=(g=o.containerPointToLatLng(L.point(f.x,0))).lat)>90&&(g=90),f=o.latLngToContainerPoint(L.latLng(g,s));var y=o.containerPointToLatLng(L.point(r.x,_));(y=y.lat)<-90&&(y=-90),r=o.latLngToContainerPoint(L.latLng(y,s))}l.beginPath(),l.moveTo(f.x,f.y+1),l.lineTo(r.x,r.y-1),l.stroke(),i.options.showLabel&&t&&(n(C,f.x-h/2,c+1),n(C,r.x-h/2,_-3))}}if(r>0){for(z=r;z<=m;z+=r)z>=y&&k(this,z);for(z=0;z>=y;z-=r)z<=m&&k(this,z)}}}}),L.latlngGraticule=function(t){return new L.LatLngGraticule(t)};