L.KML=L.FeatureGroup.extend({initialize:function(e){this._kml=e,this._layers={},e&&this.addKML(e)},addKML:function(e){var t=L.KML.parseKML(e);if(t&&t.length){for(var r=0;r<t.length;r++)this.fire("addlayer",{layer:t[r]}),this.addLayer(t[r]);this.latLngs=L.KML.getLatLngs(e),this.fire("loaded")}},latLngs:[]}),L.Util.extend(L.KML,{parseKML:function(e){var t=this.parseStyles(e);this.parseStyleMap(e,t);for(var r,a=e.getElementsByTagName("Folder"),n=[],o=0;o<a.length;o++)this._check_folder(a[o])&&(r=this.parseFolder(a[o],t))&&n.push(r);a=e.getElementsByTagName("Placemark");for(var l=0;l<a.length;l++)this._check_folder(a[l])&&(r=this.parsePlacemark(a[l],e,t))&&n.push(r);a=e.getElementsByTagName("GroundOverlay");for(var s=0;s<a.length;s++)(r=this.parseGroundOverlay(a[s]))&&n.push(r);return n},_check_folder:function(e,t){for(e=e.parentNode;e&&"Folder"!==e.tagName;)e=e.parentNode;return!e||e===t},parseStyles:function(e){for(var t={},r=e.getElementsByTagName("Style"),a=0,n=r.length;a<n;a++){var o=this.parseStyle(r[a]);if(o)t["#"+o.id]=o}return t},parseStyle:function(e){var t,r,a={},n={},o={},l={color:!0,width:!0,Icon:!0,href:!0,hotSpot:!0};function s(e){for(var t={},r=0;r<e.childNodes.length;r++){var a=e.childNodes[r],n=a.tagName;if(l[n])if("hotSpot"===n)for(var i=0;i<a.attributes.length;i++)t[a.attributes[i].name]=a.attributes[i].nodeValue;else{var h=a.childNodes[0].nodeValue;"color"===n?(t.opacity=parseInt(h.substring(0,2),16)/255,t.color="#"+h.substring(6,8)+h.substring(4,6)+h.substring(2,4)):"width"===n?t.weight=h:"Icon"===n?(o=s(a)).href&&(t.href=o.href):"href"===n&&(t.href=h)}}return t}return(t=e.getElementsByTagName("LineStyle"))&&t[0]&&(a=s(t[0])),(t=e.getElementsByTagName("PolyStyle"))&&t[0]&&(n=s(t[0])),n.color&&(a.fillColor=n.color),n.opacity&&(a.fillOpacity=n.opacity),(t=e.getElementsByTagName("IconStyle"))&&t[0]&&(o=s(t[0])),o.href&&(a.icon=new L.KMLIcon({iconUrl:o.href,shadowUrl:null,anchorRef:{x:o.x,y:o.y},anchorType:{x:o.xunits,y:o.yunits}})),(r=e.getAttribute("id"))&&a&&(a.id=r),a},parseStyleMap:function(e,t){for(var r=e.getElementsByTagName("StyleMap"),a=0;a<r.length;a++){var n,o,l,s=r[a];(n=s.getElementsByTagName("key"))&&n[0]&&(o=n[0].textContent),(n=s.getElementsByTagName("styleUrl"))&&n[0]&&(l=n[0].textContent),"normal"===o&&(t["#"+s.getAttribute("id")]=t[l])}},parseFolder:function(e,t){var r,a,n=[];r=e.getElementsByTagName("Folder");for(var o=0;o<r.length;o++)this._check_folder(r[o],e)&&(a=this.parseFolder(r[o],t))&&n.push(a);r=e.getElementsByTagName("Placemark");for(var l=0;l<r.length;l++)this._check_folder(r[l],e)&&(a=this.parsePlacemark(r[l],e,t))&&n.push(a);r=e.getElementsByTagName("GroundOverlay");for(var s=0;s<r.length;s++)this._check_folder(r[s],e)&&(a=this.parseGroundOverlay(r[s]))&&n.push(a);if(n.length)return 1===n.length?n[0]:new L.FeatureGroup(n)},parsePlacemark:function(e,t,r,a){var n,o,l,s,i,h=a||{};for(i=e.getElementsByTagName("styleUrl"),o=0;o<i.length;o++){var g=i[o].childNodes[0].nodeValue;for(var c in r[g])h[c]=r[g][c]}if(e.getElementsByTagName("Style")[0]){var d=this.parseStyle(e);if(d)for(s in d)h[s]=d[s]}var u=["MultiGeometry","MultiTrack","gx:MultiTrack"];for(n in u)for(i=e.getElementsByTagName(u[n]),o=0;o<i.length;o++)return this.parsePlacemark(i[o],t,r,h);var f=[],y=["LineString","Polygon","Point","Track","gx:Track"];for(l in y){var p=y[l];for(i=e.getElementsByTagName(p),o=0;o<i.length;o++){var m=this["parse"+p.replace(/gx:/,"")](i[o],t,h);m&&f.push(m)}}if(f.length){var N=f[0];f.length>1&&(N=new L.FeatureGroup(f));var v,T="";for((i=e.getElementsByTagName("name")).length&&i[0].childNodes.length&&(v=i[0].childNodes[0].nodeValue),i=e.getElementsByTagName("description"),o=0;o<i.length;o++)for(l=0;l<i[o].childNodes.length;l++)T+=i[o].childNodes[l].nodeValue;return v&&N.on("add",function(){N.bindPopup("<h2>"+v+"</h2>"+T,{className:"kml-popup"})}),N}},parseCoords:function(e){var t=e.getElementsByTagName("coordinates");return this._read_coords(t[0])},parseLineString:function(e,t,r){var a=this.parseCoords(e);if(a.length)return new L.Polyline(a,r)},parseTrack:function(e,t,r){var a=t.getElementsByTagName("gx:coord");0===a.length&&(a=t.getElementsByTagName("coord"));for(var n=[],o=0;o<a.length;o++)n=n.concat(this._read_gxcoords(a[o]));if(n.length)return new L.Polyline(n,r)},parsePoint:function(e,t,r){var a=e.getElementsByTagName("coordinates");if(a.length){var n=a[0].childNodes[0].nodeValue.split(",");return new L.KMLMarker(new L.LatLng(n[1],n[0]),r)}},parsePolygon:function(e,t,r){var a,n,o,l=[],s=[];for(a=e.getElementsByTagName("outerBoundaryIs"),n=0;n<a.length;n++)(o=this.parseCoords(a[n]))&&l.push(o);for(a=e.getElementsByTagName("innerBoundaryIs"),n=0;n<a.length;n++)(o=this.parseCoords(a[n]))&&s.push(o);if(l.length)return r.fillColor&&(r.fill=!0),1===l.length?new L.Polygon(l.concat(s),r):new L.MultiPolygon(l,r)},getLatLngs:function(e){for(var t=e.getElementsByTagName("coordinates"),r=[],a=0;a<t.length;a++)r=r.concat(this._read_coords(t[a]));return r},_read_coords:function(e){var t,r="",a=[];for(t=0;t<e.childNodes.length;t++)r+=e.childNodes[t].nodeValue;for(r=r.split(/[\s\n]+/),t=0;t<r.length;t++){var n=r[t].split(",");n.length<2||a.push(new L.LatLng(n[1],n[0]))}return a},_read_gxcoords:function(e){var t,r=[];return t=e.firstChild.nodeValue.split(" "),r.push(new L.LatLng(t[1],t[0])),r},parseGroundOverlay:function(e){var t=e.getElementsByTagName("LatLonBox")[0],r=new L.LatLngBounds([t.getElementsByTagName("south")[0].childNodes[0].nodeValue,t.getElementsByTagName("west")[0].childNodes[0].nodeValue],[t.getElementsByTagName("north")[0].childNodes[0].nodeValue,t.getElementsByTagName("east")[0].childNodes[0].nodeValue]),a={Icon:!0,href:!0,color:!0};var n={};if(n=function e(t){for(var r={},n={},o=0;o<t.childNodes.length;o++){var l=t.childNodes[o],s=l.tagName;if(a[s]){var i=l.childNodes[0].nodeValue;"Icon"===s?(n=e(l)).href&&(r.href=n.href):"href"===s?r.href=i:"color"===s&&(r.opacity=parseInt(i.substring(0,2),16)/255,r.color="#"+i.substring(6,8)+i.substring(4,6)+i.substring(2,4))}}return r}(e),void 0!==t.getElementsByTagName("rotation")[0]){var o=t.getElementsByTagName("rotation")[0].childNodes[0].nodeValue;n.rotation=parseFloat(o)}return new L.RotatedImageOverlay(n.href,r,{opacity:n.opacity,angle:n.rotation})}}),L.KMLIcon=L.Icon.extend({options:{iconSize:[32,32],iconAnchor:[16,16]},_setIconStyles:function(e,t){L.Icon.prototype._setIconStyles.apply(this,[e,t]),e.complete?this.applyCustomStyles(e):e.onload=this.applyCustomStyles.bind(this,e)},applyCustomStyles:function(e){var t=this.options;this.options.popupAnchor=[0,-.83*e.height],"fraction"===t.anchorType.x&&(e.style.marginLeft=-t.anchorRef.x*e.width+"px"),"fraction"===t.anchorType.y&&(e.style.marginTop=-(1-t.anchorRef.y)*e.height+1+"px"),"pixels"===t.anchorType.x&&(e.style.marginLeft=-t.anchorRef.x+"px"),"pixels"===t.anchorType.y&&(e.style.marginTop=t.anchorRef.y-e.height+1+"px")}}),L.KMLMarker=L.Marker.extend({options:{icon:new L.KMLIcon.Default}}),L.RotatedImageOverlay=L.ImageOverlay.extend({options:{angle:0},_reset:function(){L.ImageOverlay.prototype._reset.call(this),this._rotate()},_animateZoom:function(e){L.ImageOverlay.prototype._animateZoom.call(this,e),this._rotate()},_rotate:function(){if(L.DomUtil.TRANSFORM)this._image.style[L.DomUtil.TRANSFORM]+=" rotate("+this.options.angle+"deg)";else if(L.Browser.ie){var e=this.options.angle*(Math.PI/180),t=Math.cos(e),r=Math.sin(e);this._image.style.filter+=" progid:DXImageTransform.Microsoft.Matrix(sizingMethod='auto expand', M11="+t+", M12="+-r+", M21="+r+", M22="+t+")"}},getBounds:function(){return this._bounds}});